#!/usr/bin/env bash
# biasctl – điều khiển BiasService (FastAPI)
# Usage: ./biasctl start|stop|restart|status
set -euo pipefail

SERVICE_DIR="$(cd "$(dirname "$0")" && pwd)"
VENV="$SERVICE_DIR/.venv"
PIDFILE="$SERVICE_DIR/biasservice.pid"
LOGFILE="$SERVICE_DIR/biasservice.log"
HOST="0.0.0.0"
PORT=8000

start() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    echo "⚠️  BiasService đã chạy (PID $(<"$PIDFILE"))."
    exit 0
  fi
  source "$VENV/bin/activate"
  nohup uvicorn app:app --host $HOST --port $PORT >>"$LOGFILE" 2>&1 &
  echo $! > "$PIDFILE"
  echo "🟢 BiasService STARTED – PID $!, port $PORT"
}

stop() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    kill $(<"$PIDFILE") && rm -f "$PIDFILE"
    echo "🔴 BiasService STOPPED."
  else
    echo "ℹ️  BiasService không chạy."
  fi
}

status() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    echo "🟢 BiasService đang chạy – PID $(<"$PIDFILE")."
  else
    echo "🔴 BiasService chưa chạy."
  fi
}

case "${1:-}" in
  start)   start ;;
  stop)    stop ;;
  restart) stop; start ;;
  status)  status ;;
  *) echo "Dùng: $0 {start|stop|restart|status}" ;;
esac

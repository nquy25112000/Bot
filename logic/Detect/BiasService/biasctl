#!/usr/bin/env bash
# biasctl â€“ Ä‘iá»u khiá»ƒn BiasService (FastAPI)
# Usage: ./biasctl start|stop|restart|status
set -euo pipefail

SERVICE_DIR="$(cd "$(dirname "$0")" && pwd)"
VENV="$SERVICE_DIR/.venv"
PIDFILE="$SERVICE_DIR/biasservice.pid"
LOGFILE="$SERVICE_DIR/biasservice.log"
HOST="0.0.0.0"
PORT=8000

start() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    echo "âš ï¸  BiasService Ä‘Ã£ cháº¡y (PID $(<"$PIDFILE"))."
    exit 0
  fi
  source "$VENV/bin/activate"
  nohup uvicorn app:app --host $HOST --port $PORT >>"$LOGFILE" 2>&1 &
  echo $! > "$PIDFILE"
  echo "ğŸŸ¢ BiasService STARTED â€“ PID $!, port $PORT"
}

stop() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    kill $(<"$PIDFILE") && rm -f "$PIDFILE"
    echo "ğŸ”´ BiasService STOPPED."
  else
    echo "â„¹ï¸  BiasService khÃ´ng cháº¡y."
  fi
}

status() {
  if [[ -f "$PIDFILE" ]] && kill -0 $(<"$PIDFILE") 2>/dev/null; then
    echo "ğŸŸ¢ BiasService Ä‘ang cháº¡y â€“ PID $(<"$PIDFILE")."
  else
    echo "ğŸ”´ BiasService chÆ°a cháº¡y."
  fi
}

case "${1:-}" in
  start)   start ;;
  stop)    stop ;;
  restart) stop; start ;;
  status)  status ;;
  *) echo "DÃ¹ng: $0 {start|stop|restart|status}" ;;
esac
